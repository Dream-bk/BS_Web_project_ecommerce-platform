<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线电商平台 - 管理后台</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <style>
        .admin-header {
            border-bottom: 2px solid #ff0036;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .admin-header h1 {
            font-size: 24px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .admin-header h1 i {
            margin-right: 10px;
            color: #ff0036;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .admin-section h2 i {
            margin-right: 8px;
            color: #ff0036;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border: 1px solid #eee;
        }

        .admin-table th,
        .admin-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
            font-size: 14px;
            color: #333;
        }

        .admin-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }

        .admin-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-admin {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #ff0036;
            background-color: #ff0036;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-admin.secondary {
            background-color: #fff;
            color: #ff0036;
        }

        .btn-admin.danger {
            border-color: #cc0033;
            background-color: #cc0033;
            color: #fff;
        }

        .admin-form {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-form input,
        .admin-form textarea,
        .admin-form select {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
        }

        .admin-form textarea {
            grid-column: span 6;
            resize: vertical;
            min-height: 60px;
        }

        .admin-form .form-actions {
            grid-column: span 6;
            display: flex;
            gap: 10px;
        }

        .status-chip {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
            background-color: #f5f5f5;
        }

        .status-chip.pending {
            background-color: #fff5f5;
            color: #ff9900;
        }

        .status-chip.paid {
            background-color: #f0fff4;
            color: #00cc66;
        }

        .status-chip.shipped {
            background-color: #f0f8ff;
            color: #0099cc;
        }

        .status-chip.delivered,
        .status-chip.completed {
            background-color: #f5f5f5;
            color: #666;
        }

        .status-chip.cancelled {
            background-color: #fef2f2;
            color: #cc0033;
        }

        .admin-tip {
            color: #666;
            font-size: 13px;
            margin-top: 8px;
        }

        @media (max-width: 1200px) {
            .admin-form {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .admin-form {
                grid-template-columns: 1fr;
            }

            .admin-table th,
            .admin-table td {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="container">
            <div class="welcome-text">欢迎来到在线电商平台</div>
            <div class="top-links">
                <a href="login.html">登录</a>
                <a href="register.html">注册</a>
                <a href="orders.html">我的订单</a>
                <a id="customerServiceLink">客户服务</a>
            </div>
        </div>
    </div>

    <header class="main-nav">
        <div class="container">
            <a href="index.html" class="logo">
                <i class="fas fa-shopping-bag"></i>
                E-Shop
            </a>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="搜索商品...">
                <button id="searchButton"><i class="fas fa-search"></i></button>
            </div>

            <div class="user-actions">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>首页</span>
                </a>
                <a href="cart.html" class="nav-link">
                    <div class="cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                        <div class="cart-count" id="cartCount">0</div>
                    </div>
                    <span>购物车</span>
                </a>
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="admin-header">
            <h1><i class="fas fa-tools"></i> 管理后台</h1>
        </div>

        <div class="admin-section">
            <h2><i class="fas fa-box"></i> 商品管理</h2>
            <form id="addProductForm" class="admin-form">
                <input type="text" id="productName" placeholder="商品名称" required>
                <input type="number" id="productPrice" placeholder="售价" step="0.01" min="0.01" required>
                <input type="number" id="productOriginalPrice" placeholder="原价(可选)" step="0.01" min="0">
                <input type="number" id="productStock" placeholder="库存" min="0" required>
                <input type="text" id="productCategory" placeholder="分类(如 electronics)">
                <input type="text" id="productImage" placeholder="图片路径(可选)">
                <textarea id="productDescription" placeholder="商品描述(可选)"></textarea>
                <div class="form-actions">
                    <button type="submit" class="btn-admin">新增商品</button>
                    <button type="button" class="btn-admin secondary" id="refreshProducts">刷新列表</button>
                </div>
            </form>
            <div class="admin-tip">提示：分类值需与前端分类对应，如 electronics、clothing、appliances。</div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>分类</th>
                        <th>价格</th>
                        <th>库存</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <tr><td colspan="7">加载中...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="admin-section">
            <h2><i class="fas fa-receipt"></i> 订单管理</h2>
            <div class="admin-actions" style="margin-bottom: 10px;">
                <button class="btn-admin secondary" id="refreshOrders">刷新订单</button>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>订单号</th>
                        <th>时间</th>
                        <th>金额</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr><td colspan="5">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>购物指南</h3>
                <ul>
                    <li><a>购物流程</a></li>
                    <li><a>会员介绍</a></li>
                    <li><a>常见问题</a></li>
                    <li><a>联系客服</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>配送方式</h3>
                <ul>
                    <li><a>上门自提</a></li>
                    <li><a>配送服务</a></li>
                    <li><a>配送费用</a></li>
                    <li><a>物流查询</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>支付方式</h3>
                <ul>
                    <li><a>在线支付</a></li>
                    <li><a>货到付款</a></li>
                    <li><a>分期付款</a></li>
                    <li><a>礼品卡支付</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>售后服务</h3>
                <ul>
                    <li><a>退换货政策</a></li>
                    <li><a>退款说明</a></li>
                    <li><a>保修政策</a></li>
                    <li><a>投诉建议</a></li>
                </ul>
            </div>
        </div>

        <div class="copyright">
            <p>© 2023 在线电商平台 版权所有 | 联系我们: service@eshop.com | 电话: 400-123-4567</p>
        </div>
    </footer>

    <script src="assets/js/shared-data.js"></script>
    <script>
        let productsCache = [];
        let ordersCache = [];

        function renderProducts(products) {
            const tbody = document.getElementById('productTableBody');
            if (!products.length) {
                tbody.innerHTML = '<tr><td colspan="7">暂无商品</td></tr>';
                return;
            }
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.category || '-'}</td>
                    <td><input type="number" data-field="price" data-id="${product.id}" value="${Number(product.price).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" data-field="stock" data-id="${product.id}" value="${Number(product.stock ?? 0)}" min="0"></td>
                    <td>${product.is_active === false ? '下架' : '上架'}</td>
                    <td>
                        <div class="admin-actions">
                            <button class="btn-admin" data-action="update" data-id="${product.id}">更新</button>
                            <button class="btn-admin danger" data-action="delete" data-id="${product.id}">下架</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('orderTableBody');
            if (!orders.length) {
                tbody.innerHTML = '<tr><td colspan="5">暂无订单</td></tr>';
                return;
            }
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.order_number}</td>
                    <td>${order.created_at}</td>
                    <td>&yen;${Number(order.total_amount).toFixed(2)}</td>
                    <td><span class="status-chip ${order.status}">${order.status}</span></td>
                    <td>
                        <div class="admin-actions">
                            <select data-order="${order.id}">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>pending</option>
                                <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>paid</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>shipped</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>cancelled</option>
                            </select>
                            <button class="btn-admin" data-action="update-order" data-id="${order.id}">更新状态</button>
                            <button class="btn-admin secondary" data-action="view-order" data-id="${order.id}">查看详情</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function loadProducts() {
            const list = [];
            let page = 1;
            while (true) {
                const data = await apiRequest(`/products?page=${page}&per_page=50`);
                const products = Array.isArray(data.products) ? data.products : [];
                list.push(...products);
                if (!data.pagination || page >= data.pagination.pages) {
                    break;
                }
                page += 1;
            }
            productsCache = list;
            renderProducts(productsCache);
        }

        async function loadOrders() {
            ordersCache = await apiGetOrders();
            renderOrders(ordersCache);
        }

        async function addProduct(payload) {
            await apiRequest('/products', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
        }

        async function updateProduct(productId, payload) {
            await apiRequest(`/products/${productId}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
        }

        async function deleteProduct(productId) {
            await apiRequest(`/products/${productId}`, { method: 'DELETE' });
        }

        async function updateOrderStatus(orderId, status) {
            await apiUpdateOrderStatus(orderId, status);
        }

        function bindProductActions() {
            document.getElementById('productTableBody').addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const productId = Number(button.dataset.id);
                if (button.dataset.action === 'update') {
                    const priceInput = document.querySelector(`input[data-field=\"price\"][data-id=\"${productId}\"]`);
                    const stockInput = document.querySelector(`input[data-field=\"stock\"][data-id=\"${productId}\"]`);
                    const payload = {
                        price: Number(priceInput.value),
                        stock: Number(stockInput.value)
                    };
                    await updateProduct(productId, payload);
                    alert('商品已更新');
                    await loadProducts();
                } else if (button.dataset.action === 'delete') {
                    if (!confirm('确认下架该商品？')) return;
                    await deleteProduct(productId);
                    alert('商品已下架');
                    await loadProducts();
                }
            });
        }

        function bindOrderActions() {
            document.getElementById('orderTableBody').addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const orderId = Number(button.dataset.id);
                if (button.dataset.action === 'update-order') {
                    const select = document.querySelector(`select[data-order=\"${orderId}\"]`);
                    await updateOrderStatus(orderId, select.value);
                    alert('订单状态已更新');
                    await loadOrders();
                } else if (button.dataset.action === 'view-order') {
                    const order = ordersCache.find(o => o.id === orderId);
                    if (!order) return;
                    const items = (order.items || []).map(item => `${item.product_name} x ${item.quantity}`).join('\n');
                    alert(`订单号：${order.order_number}\n金额：${Number(order.total_amount).toFixed(2)}\n状态：${order.status}\n\n商品明细：\n${items}`);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await refreshCartCount();

            document.getElementById('searchButton').addEventListener('click', function() {
                const query = document.getElementById('searchInput').value.trim();
                if (query) {
                    window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                } else {
                    alert('请输入搜索关键词');
                }
            });

            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', function() {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        const user = JSON.parse(storedUser);
                        alert(`欢迎 ${user.name || user.username}`);
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            }

            const customerServiceLink = document.getElementById('customerServiceLink');
            if (customerServiceLink) {
                customerServiceLink.addEventListener('click', function() {
                    alert('客服功能正在开发中...');
                });
            }

            try {
                const user = await apiGetCurrentUser();
                if (!user.is_admin) {
                    alert('仅管理员可访问管理后台');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (err) {
                alert('请先登录管理员账号');
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('addProductForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const payload = {
                    name: document.getElementById('productName').value.trim(),
                    price: Number(document.getElementById('productPrice').value),
                    original_price: document.getElementById('productOriginalPrice').value
                        ? Number(document.getElementById('productOriginalPrice').value)
                        : undefined,
                    stock: Number(document.getElementById('productStock').value),
                    category: document.getElementById('productCategory').value.trim(),
                    image: document.getElementById('productImage').value.trim(),
                    description: document.getElementById('productDescription').value.trim()
                };
                await addProduct(payload);
                alert('商品已新增');
                e.target.reset();
                await loadProducts();
            });

            document.getElementById('refreshProducts').addEventListener('click', loadProducts);
            document.getElementById('refreshOrders').addEventListener('click', loadOrders);

            bindProductActions();
            bindOrderActions();
            await loadProducts();
            await loadOrders();
        });
    </script>
</body>
</html>
